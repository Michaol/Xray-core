name: Sync Upstream and Build

on:
  schedule:
    - cron: '0 4 * * *' # Run daily at 4:00 AM UTC
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Sync with Upstream
        id: sync
        run: |
          git remote add upstream https://github.com/xtls/xray-core.git
          git fetch upstream
          
          # Get current hash
          BEFORE_SHA=$(git rev-parse HEAD)
          
          # Merge upstream/main
          # Using --no-edit to accept default merge message
          git merge upstream/main --no-edit
          
          # Get new hash
          AFTER_SHA=$(git rev-parse HEAD)
          
          if [ "$BEFORE_SHA" != "$AFTER_SHA" ]; then
            git push
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "No updates from upstream."
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Build
        if: steps.sync.outputs.updated == 'true' || github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering release workflow..."
          gh workflow run release.yml --ref main
